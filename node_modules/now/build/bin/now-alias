#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function indent(e,r){return e.split("\n").map(function(e){return" ".repeat(r)+e}).join("\n")}function findAlias(e,r){var t=void 0,a=void 0;/\./.test(e)?(a=(0,_toHost2["default"])(e),t="alias"):(a=e,t="uid");var n=r.find(function(e){return e[t]===a?(debug&&console.log("> [debug] matched alias "+e.uid+" by "+t+" "+a),!0):a+".now.sh"===e.alias?(debug&&console.log("> [debug] matched alias "+e.uid+" by url "+e.host),!0):!1});return n}var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),run=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var t,a,n,i=this;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t=new _alias3["default"](apiUrl,e,{debug:debug}),a=argv._.slice(1),r.delegateYield(_regenerator2["default"].mark(function l(){var e,r,n,u,o,s,d,c,f,_,p,m,h;return _regenerator2["default"].wrap(function(i){for(;;)switch(i.prev=i.next){case 0:i.t0=subcommand,i.next="list"===i.t0?3:"ls"===i.t0?3:"remove"===i.t0?18:"rm"===i.t0?18:"add"===i.t0?51:"set"===i.t0?51:57;break;case 3:if(0===a.length){i.next=6;break}return(0,_error.error)("Invalid number of arguments"),i.abrupt("return",{v:exit(1)});case 6:return i.next=8,t.list();case 8:return e=i.sent,r=new _map2["default"](e.map(function(e){return[e.uid,e.url]})),i.next=12,t.ls();case 12:return n=i.sent,n.sort(function(e,r){return new Date(r.created)-new Date(e.created)}),u=new Date,o=(0,_textTable2["default"])(n.map(function(e){var t=_chalk2["default"].underline("https://"+e.alias),a=e.deploymentId,n=r.get(a)?_chalk2["default"].underline("https://"+r.get(a)):_chalk2["default"].gray("<null>"),i=_chalk2["default"].gray((0,_ms2["default"])(u-new Date(e.created))+" ago");return["",null==e.uid?"":e.uid,n,t,i]}),{align:["l","r","l"],hsep:" ".repeat(3)}),o&&console.log("\n"+o+"\n"),i.abrupt("break",63);case 18:if(s=String(a[0])){i.next=23;break}throw d=new Error("No alias id specified"),d.userError=!0,d;case 23:if(1===a.length){i.next=26;break}return(0,_error.error)("Invalid number of arguments"),i.abrupt("return",{v:exit(1)});case 26:return i.next=28,t.ls();case 28:if(c=i.sent,f=findAlias(s,c)){i.next=34;break}throw _=new Error('Alias not found by "'+s+'". Run '+_chalk2["default"].dim("`now alias ls`")+" to see your aliases."),_.userError=!0,_;case 34:return i.prev=34,i.next=37,readConfirmation(t,f,c);case 37:return p=i.sent.toLowerCase(),"y"!==p&&"yes"!==p&&(console.log("\n> Aborted"),process.exit(0)),m=new Date,i.next=42,t.rm(f);case 42:h=(0,_ms2["default"])(new Date-m),console.log(_chalk2["default"].cyan("> Success!")+" Alias "+_chalk2["default"].bold(f.uid)+" removed ["+h+"]"),i.next=50;break;case 46:i.prev=46,i.t1=i["catch"](34),(0,_error.error)(i.t1),exit(1);case 50:return i.abrupt("break",63);case 51:if(2===a.length){i.next=54;break}return(0,_error.error)("Invalid number of arguments"),i.abrupt("return",{v:exit(1)});case 54:return i.next=56,t.set(String(a[0]),String(a[1]));case 56:return i.abrupt("break",63);case 57:if(2!==argv._.length){i.next=62;break}return i.next=60,t.set(String(argv._[0]),String(argv._[1]));case 60:i.next=63;break;case 62:argv._.length>=3?((0,_error.error)("Invalid number of arguments"),help(),exit(1)):((0,_error.error)("Please specify a valid subcommand: ls | set | rm"),help(),exit(1));case 63:case"end":return i.stop()}},l,i,[[34,46]])})(),"t0",3);case 3:if(n=r.t0,"object"!==("undefined"==typeof n?"undefined":(0,_typeof3["default"])(n))){r.next=6;break}return r.abrupt("return",n.v);case 6:t.close();case 7:case"end":return r.stop()}},r,this)}));return function(r){return e.apply(this,arguments)}}(),readConfirmation=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t,a){var n,i;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.list();case 2:return n=r.sent,i=new _map2["default"](n.map(function(e){return[e.uid,e.url]})),r.abrupt("return",new _promise2["default"](function(e,r){var a=_chalk2["default"].gray((0,_ms2["default"])(new Date-new Date(t.created))+" ago"),n=_chalk2["default"].underline("https://"+i.get(t.deploymentId)),l=(0,_textTable2["default"])([[t.uid,n,_chalk2["default"].underline("https://"+t.alias),a]],{align:["l","r","l"],hsep:" ".repeat(6)});process.stdout.write("> The following deployment will be removed permanently\n"),process.stdout.write("  "+l+"\n"),process.stdout.write("  "+_chalk2["default"].bold.red("> Are you sure?")+" "+_chalk2["default"].gray("[yN] ")),process.stdin.on("data",function(r){process.stdin.pause(),e(r.toString().trim())}).resume()}));case 5:case"end":return r.stop()}},r,this)}));return function(r,t,a){return e.apply(this,arguments)}}(),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_textTable=require("text-table"),_textTable2=_interopRequireDefault(_textTable),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_alias2=require("../lib/alias"),_alias3=_interopRequireDefault(_alias2),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_error=require("../lib/error"),_toHost=require("../lib/to-host"),_toHost2=_interopRequireDefault(_toHost),argv=(0,_minimist2["default"])(process.argv.slice(2),{"boolean":["help","debug"],alias:{help:"h",debug:"d"}}),subcommand=argv._[0],help=function(){console.log("\n  "+_chalk2["default"].bold("ùö´ now alias")+" <ls | set | rm> <deployment> <alias>\n\n  "+_chalk2["default"].dim("Options:")+"\n\n    -h, --help   output usage information\n    -d, --debug  debug mode [off]\n\n  "+_chalk2["default"].dim("Examples:")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Lists all your aliases:\n\n      "+_chalk2["default"].cyan("$ now alias ls")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Adds a new alias to "+_chalk2["default"].underline("my-api.now.sh")+":\n\n      "+_chalk2["default"].cyan("$ now alias set "+_chalk2["default"].underline("api-ownv3nc9f8.now.sh")+" "+_chalk2["default"].underline("my-api.now.sh"))+"\n\n      The "+_chalk2["default"].dim("`.now.sh`")+" suffix can be ommited:\n\n      "+_chalk2["default"].cyan("$ now alias set api-ownv3nc9f8 my-api")+"\n\n      The deployment id can be used as the source:\n\n      "+_chalk2["default"].cyan("$ now alias set deploymentId my-alias")+"\n\n      Custom domains work as alias targets:\n\n      "+_chalk2["default"].cyan("$ now alias set "+_chalk2["default"].underline("api-ownv3nc9f8.now.sh")+" "+_chalk2["default"].underline("my-api.com"))+"\n\n      "+_chalk2["default"].dim("‚Äì")+" The subcommand "+_chalk2["default"].dim("`set`")+" is the default and can be skipped.\n      "+_chalk2["default"].dim("‚Äì")+" "+_chalk2["default"].dim("`http(s)://`")+" in the URLs is unneeded / ignored.\n\n  "+_chalk2["default"].gray("‚Äì")+" Removing an alias:\n\n      "+_chalk2["default"].cyan("$ now alias rm aliasId")+"\n\n      To get the list of alias ids, use "+_chalk2["default"].dim("`now alias ls`")+".\n\n  "+_chalk2["default"].dim("Alias:")+" ln\n")},debug=argv.debug,apiUrl=argv.url||"https://api.zeit.co",exit=function(e){setTimeout(function(){return process.exit(e||0)},100)};if(argv.help||!subcommand)help(),exit(0);else{var config=cfg.read();_promise2["default"].resolve(config.token||(0,_login2["default"])(apiUrl)).then(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,run(e);case 3:r.next=9;break;case 5:r.prev=5,r.t0=r["catch"](0),r.t0.userError?(0,_error.error)(r.t0.message):(0,_error.error)("Unknown error: "+r.t0.stack),exit(1);case 9:case"end":return r.stop()}},r,void 0,[[0,5]])}));return function(r){return e.apply(this,arguments)}}())["catch"](function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),exit(1)})}